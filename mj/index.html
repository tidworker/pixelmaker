<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>麻將計分系統 - 主畫面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    .info, .section { margin-top: 10px; }
    .section { margin-top: 20px; }
    table, th, td {
      border: 1px solid #333;
      border-collapse: collapse;
      padding: 6px 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    input[type="number"] { width: 50px; text-align: center; }
    button { font-size: 1rem; padding: 4px 8px; margin: 4px 2px; cursor: pointer; }
    /* 按鈕組樣式 */
    .button-group { display: inline-block; }
    .button-group button {
      margin-right: 4px;
      background-color: #eee;
      border: 1px solid #ccc;
      padding: 6px 10px;
    }
    .button-group button.selected {
      background-color: #4285F4;
      color: white;
      border-color: #4285F4;
    }
    /* 模態框 (modal) 樣式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 500px;
      border-radius: 5px;
    }
    .modal-header { font-size: 1.2rem; margin-bottom: 10px; }
    .modal-footer { margin-top: 20px; text-align: right; }
    .modal-form div { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>麻將計分系統</h1>
  <p>
    ※ 點選【計分】按鈕後，會彈出模態框依序選擇：<br>
    1. 獲勝玩家（a、b、c、d）<br>
    2. 計分方式（胡 或 自摸；若選胡則會顯示失分玩家選項）<br>
    3. 調整台數（旁邊有 ± 按鈕）<br>
    計分規則：<br>
    • 胡牌：<br>
  – 若獲勝者為莊家 a，bonus = (連莊數×2)+1，得分 = (台數 + bonus + 底分)，對手扣分同值，連莊數累加；<br>
  – 若非莊家胡牌，得分 = (台數 + 底分)，對手扣分同值，連莊數重置。<br>
    • 自摸：<br>
  – 莊家 a 自摸：a 得分 = 3×(台數 + bonus + 1 + 底分)，其他三家各扣 (台數 + bonus + 1 + 底分)，連莊數累加；<br>
  – 非莊家自摸：a 失分 = (台數 + bonus + 1 + 底分)，其他非莊家玩家各失 (台數 + 1 + 底分)，自摸玩家得分 = 3×台數 + bonus + 3 + 3×底分，連莊數重置。<br>
    ※ 【設定】按鈕可進入設定頁，設定玩家名稱、底分（每局計分時加減的分數）與倍率（計分結果乘以此倍率）。
  </p>
  
  <!-- 主畫面按鈕 -->
  <button type="button" onclick="openModal('scoreModal')">計分</button>
  <button type="button" onclick="window.location.href='settings.html'">設定</button>
  <button type="button" onclick="resetScores()">清空分數</button>
  
  <div class="info">
    當前莊數：<span id="dealerCountDisplay">0</span>　
    當前局數：<span id="roundDisplay">1</span>
  </div>
  
  <!-- 計分模態框 -->
  <div id="scoreModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">請選擇計分參數</div>
      <div class="modal-form">
        <div>
          <label>獲勝玩家：</label>
          <div id="winnerGroup" class="button-group">
            <button type="button" data-value="a" class="select-button selected">a</button>
            <button type="button" data-value="b" class="select-button">b</button>
            <button type="button" data-value="c" class="select-button">c</button>
            <button type="button" data-value="d" class="select-button">d</button>
          </div>
        </div>
        <div>
          <label>計分方式：</label>
          <div id="scoreTypeGroup" class="button-group">
            <button type="button" data-value="hu" class="select-button selected">胡</button>
            <button type="button" data-value="zimo" class="select-button">自摸</button>
          </div>
        </div>
        <div id="loserDiv">
          <label>失分玩家：</label>
          <div id="loserGroup" class="button-group">
            <button type="button" data-value="a" class="select-button">a</button>
            <button type="button" data-value="b" class="select-button selected">b</button>
            <button type="button" data-value="c" class="select-button">c</button>
            <button type="button" data-value="d" class="select-button">d</button>
          </div>
        </div>
        <div>
          <label>台數：</label>
          <button type="button" onclick="decrementPoints()">−</button>
          <input type="number" id="pointsInput" value="0" min="0">
          <button type="button" onclick="incrementPoints()">＋</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeModal('scoreModal')">取消</button>
        <button type="button" onclick="modalSubmit()">送出</button>
      </div>
    </div>
  </div>
  
  <div class="section">
    <h2>每局計分</h2>
    <div id="roundResultsTable"></div>
  </div>
  
  <div class="section">
    <h2>總積分</h2>
    <table>
      <tr>
        <th>玩家</th>
        <th>總積分</th>
      </tr>
      <tr>
        <td id="nameA">a</td>
        <td id="totalScoreA">0</td>
      </tr>
      <tr>
        <td id="nameB">b</td>
        <td id="totalScoreB">0</td>
      </tr>
      <tr>
        <td id="nameC">c</td>
        <td id="totalScoreC">0</td>
      </tr>
      <tr>
        <td id="nameD">d</td>
        <td id="totalScoreD">0</td>
      </tr>
    </table>
  </div>
  
  <script>
    // 全域變數
    // 讀取 localStorage 中的設定（若無則採預設值）
    var playerNames = { a: "a", b: "b", c: "c", d: "d" };
    var baseScore = parseFloat(localStorage.getItem("baseScore")) || 0;
    var multiplier = parseFloat(localStorage.getItem("multiplier")) || 1;
    var storedNames = localStorage.getItem("playerNames");
    if (storedNames) {
      playerNames = JSON.parse(storedNames);
    }
    
    // 初始總積分設為 0（底分不再是初始積分，而是每局計分時加扣）
    var totalScores = { a: 0, b: 0, c: 0, d: 0 };
    var roundResults = [];   // 每筆資料形如 { round: 1, a: ..., b: ..., c: ..., d: ... }
    var dealerCount = 0;
    var roundNumber = 1;
    
    // 更新畫面：顯示當前莊數、局數、每局計分表、總積分及玩家名稱
    function updateDisplay() {
      document.getElementById('dealerCountDisplay').innerText = dealerCount;
      document.getElementById('roundDisplay').innerText = roundNumber;
      
      document.getElementById('totalScoreA').innerText = totalScores.a;
      document.getElementById('totalScoreB').innerText = totalScores.b;
      document.getElementById('totalScoreC').innerText = totalScores.c;
      document.getElementById('totalScoreD').innerText = totalScores.d;
      
      document.getElementById('nameA').innerText = playerNames.a;
      document.getElementById('nameB').innerText = playerNames.b;
      document.getElementById('nameC').innerText = playerNames.c;
      document.getElementById('nameD').innerText = playerNames.d;
      
      var tableHTML = "<table><tr><th>局數</th><th>" + playerNames.a + "</th><th>" + playerNames.b + "</th><th>" + playerNames.c + "</th><th>" + playerNames.d + "</th></tr>";
      roundResults.forEach(function(r) {
        tableHTML += "<tr><td>" + r.round + "</td><td>" + r.a + "</td><td>" + r.b + "</td><td>" + r.c + "</td><td>" + r.d + "</td></tr>";
      });
      tableHTML += "</table>";
      document.getElementById('roundResultsTable').innerHTML = tableHTML;
    }
    
    // 增加 / 減少台數
    function incrementPoints() {
      var input = document.getElementById("pointsInput");
      input.value = parseInt(input.value) + 1;
    }
    function decrementPoints() {
      var input = document.getElementById("pointsInput");
      if (parseInt(input.value) > 0) {
        input.value = parseInt(input.value) - 1;
      }
    }
    
    // 設置模態框中各按鈕組事件
    function setupButtonGroup(groupId) {
      var group = document.getElementById(groupId);
      var buttons = group.querySelectorAll('.select-button');
      buttons.forEach(function(btn) {
        btn.addEventListener('click', function() {
          buttons.forEach(function(b) { b.classList.remove('selected'); });
          this.classList.add('selected');
          if (groupId === 'scoreTypeGroup') {
            var val = this.getAttribute('data-value');
            document.getElementById('loserDiv').style.display = (val === 'zimo') ? 'none' : 'block';
          }
        });
      });
    }
    setupButtonGroup('winnerGroup');
    setupButtonGroup('scoreTypeGroup');
    setupButtonGroup('loserGroup');
    
    // 模態框控制
    function openModal(modalId) {
      document.getElementById(modalId).style.display = "block";
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }
    function modalSubmit() {
      processCommand();
      closeModal('scoreModal');
    }
    
    // 計分邏輯（最終結果乘上倍率）
    function processCommand() {
      var winner = document.querySelector('#winnerGroup .select-button.selected').getAttribute('data-value');
      var scoreType = document.querySelector('#scoreTypeGroup .select-button.selected').getAttribute('data-value');
      var points = parseInt(document.getElementById("pointsInput").value);
      if (isNaN(points) || points < 0) { alert("請輸入正確台數！"); return; }
      
      var roundScore = { a: 0, b: 0, c: 0, d: 0, round: roundNumber };
      
      if (scoreType === "hu") {
        var loser = document.querySelector('#loserGroup .select-button.selected').getAttribute('data-value');
        if (winner === loser) { alert("獲勝玩家不能與失分玩家相同！"); return; }
        if (winner === 'a') {
          var bonus = (dealerCount * 2) + 1;
          roundScore.a = points + bonus + baseScore;
          roundScore[loser] = -(points + bonus + baseScore);
          dealerCount++;
        } else {
          roundScore[winner] = points + baseScore;
          roundScore[loser] = -(points + baseScore);
          dealerCount = 0;
        }
      } else { // 自摸
        var bonus = (dealerCount * 2) + 1;
        if (winner === 'a') {
          // 莊家自摸：其他三家各扣 (points + bonus + 1 + baseScore)
          roundScore.a = 3 * (points + bonus + 1 + baseScore);
          ['b','c','d'].forEach(function(p) {
            roundScore[p] = -(points + bonus + 1 + baseScore);
          });
          dealerCount++;
        } else {
          // 非莊家自摸：
          // 莊家 a 失分 = (points + bonus + 1 + baseScore)
          // 其他非莊且非自摸者各失分 = (points + 1 + baseScore)
          // 自摸玩家得分 = [3 * points + bonus + 3] + 3 * baseScore
          roundScore[winner] = 3 * points + bonus + 3 + 3 * baseScore;
          roundScore['a'] = -(points + bonus + 1 + baseScore);
          ['b','c','d'].forEach(function(p) {
            if (p !== winner && p !== 'a') {
              roundScore[p] = -(points + 1 + baseScore);
            }
          });
          dealerCount = 0;
        }
      }
      
      // 記錄本局結果，並將各玩家本局分數乘上倍率後加入累積總分
      roundResults.push(roundScore);
      totalScores.a += roundScore.a * multiplier;
      totalScores.b += roundScore.b * multiplier;
      totalScores.c += roundScore.c * multiplier;
      totalScores.d += roundScore.d * multiplier;
      
      roundNumber++;
      updateDisplay();
      document.getElementById("pointsInput").value = 0;
    }
    
    function resetScores() {
      totalScores = { a: 0, b: 0, c: 0, d: 0 };
      roundResults = [];
      dealerCount = 0;
      roundNumber = 1;
      updateDisplay();
      document.getElementById("pointsInput").value = 0;
    }
    
    updateDisplay();
  </script>
</body>
</html>