<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>麻將計分</title>
  <style>
    /* 全域重置 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      font-family: sans-serif;
    }
    /* 主體背景、文字、排版 */
    body {
      background: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2vh;
      padding: 2vh;
    }
    /* 原本玩家按鈕樣式，作為基底 */
    .btn {
      width: 44%;
      max-width: 140px;
      padding: 3vh 0;
      margin: 1vh;
      border: 2px solid orange;
      border-radius: 10px;
      background: #000;
      color: #fff;
      font-size: 18px;
      text-align: center;
      user-select: none;
    }
    .btn:active,
    .mbtn:active {
      background: #222;
    }
    .dealer {
      border-color: red !important;
    }
    /* 分數顯示格線 */
    .grid {
      display: grid;
      gap: 2vw;
      width: 100%;
      max-width: 420px;
    }
    /* 單格樣式 */
    .cell {
      border: 2px solid orange;
      border-radius: 8px;
      padding: 1.2vh 0;
      text-align: center;
    }
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,.7);
      z-index: 99;
    }
    .box {
      background: #111;
      border: 2px solid orange;
      border-radius: 10px;
      padding: 4vh;
      width: 90%;
      max-width: 320px;
      text-align: center;
    }
    .mbtn {
      width: 80%;
      padding: 2vh 0;
      margin: 1.5vh auto;
      border: 2px solid orange;
      border-radius: 8px;
      background: #000;
      color: #fff;
      font-size: 18px;
      user-select: none;
    }
    input {
      width: 120px;
      padding: 8px;
      font-size: 18px;
      text-align: center;
      border-radius: 6px;
      border: none;
    }

    /* === 手機版：讓四個玩家按鈕平分 1/4 寬度，並保留 6px 間距 === */
    #players {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      width: 100%;
      max-width: none;
    }
    /* 讓 #players 裡的 .btn 撐滿各自格子 */
    #players .btn {
      width: 100%;
      margin: 0;
    }
  </style>
</head>
<body>

  <!-- 分數顯示 -->
  <div class="grid" id="scoreGrid">
    <div id="S東" class="cell">東 0</div>
    <div id="S南" class="cell">南 0</div>
    <div id="S西" class="cell">西 0</div>
    <div id="S北" class="cell">北 0</div>
  </div>

  <!-- 玩家按鈕 -->
  <div class="grid" id="players">
    <div class="btn" data-p="東">東</div>
    <div class="btn" data-p="南">南</div>
    <div class="btn" data-p="西">西</div>
    <div class="btn" data-p="北">北</div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="box">
      <h3 id="title">選擇</h3>
      <div id="A">
        <button class="mbtn" data-act="chi">吃胡</button>
        <button class="mbtn" data-act="zi">自摸</button>
        <button class="mbtn" id="closeM">取消</button>
      </div>
      <div id="B" style="display:none">
        <div id="guns" style="display:flex;flex-wrap:wrap;gap:2vw;justify-content:center"></div>
        <button class="mbtn" id="backA">返回</button>
      </div>
      <div id="C" style="display:none">
        <p id="tipC" style="margin-bottom:1vh">台數</p>
        <input id="tai" type="number" min="0" value="0">
        <button class="mbtn" id="ok">確定</button>
        <button class="mbtn" id="backPrev" style="margin-top:.5vh">返回</button>
      </div>
    </div>
  </div>

<script>
  /* === 固定參數 === */
  const BASE = 50;  // 底分
  const MUL  = 20;  // 台數倍率

  /* === 資料結構 === */
  const P = ["東","南","西","北"];
  const score = {東:0,南:0,西:0,北:0};
  let dealer = "東", consec = 0;

  /* === DOM 快取 === */
  const scoreEls = {}; P.forEach(p => scoreEls[p] = document.getElementById("S"+p));
  const playersDiv = document.getElementById("players");
  const modal      = document.getElementById("modal");
  const stepA      = document.getElementById("A");
  const stepB      = document.getElementById("B");
  const stepC      = document.getElementById("C");
  const titleEl    = document.getElementById("title");
  const gunsDiv    = document.getElementById("guns");
  const tipC       = document.getElementById("tipC");
  const taiInput   = document.getElementById("tai");
  const closeM     = document.getElementById("closeM");
  const backA      = document.getElementById("backA");
  const backPrev   = document.getElementById("backPrev");
  const okBtn      = document.getElementById("ok");

  const nextSeat = p => P[(P.indexOf(p)+1)%4];

  /* === UI 更新 === */
  function updateBoard(){
    P.forEach(p=>scoreEls[p].textContent = `${p} ${score[p]}`);
  }
  function updateDealerUI(){
    document.querySelectorAll(".btn").forEach(b=>b.classList.toggle("dealer",b.dataset.p===dealer));
    P.forEach(p=>scoreEls[p].classList.toggle("dealer", p===dealer));
  }
  function show(a,b,c){
    stepA.style.display=a;
    stepB.style.display=b;
    stepC.style.display=c;
  }

  /* === 主流程 === */
  let winner="", gunner="", mode="";
  playersDiv.onclick = e => {
    const p = e.target.dataset.p;
    if(!p) return;
    winner = p;
    titleEl.textContent = `${p} 胡牌方式`;
    show("block","none","none");
    modal.style.display = "flex";
  };

  stepA.onclick = e => {
    const act = e.target.dataset.act;
    if(!act) return;
    mode = act;
    if(mode==="chi"){
      gunsDiv.innerHTML="";
      P.filter(p=>p!==winner).forEach(p=>{
        const btn = document.createElement("button");
        btn.className = "mbtn";
        btn.textContent = p;
        btn.onclick = ()=>{
          gunner = p;
          tipC.textContent = `放槍 ${p} 台數`;
          show("none","none","block");
        };
        gunsDiv.appendChild(btn);
      });
      show("none","block","none");
    } else {
      gunner="";
      tipC.textContent = `${winner} 自摸 台數`;
      show("none","none","block");
    }
  };

  closeM.onclick    = ()=>modal.style.display="none";
  backA.onclick     = ()=>show("block","none","none");
  backPrev.onclick  = ()=>mode==="chi"? show("none","block","none"): show("block","none","none");

  okBtn.onclick = ()=>{
    const t = parseInt(taiInput.value,10);
    if(isNaN(t)||t<0){ alert("台數?"); return; }

    const raw   = t * MUL;
    const bonus = (consec*2+1) * MUL;
    const baseU = BASE + raw;
    const delta = {東:0,南:0,西:0,北:0};

    if(mode==="chi"){
      // A=-1 for loser; B=-1 if loser===dealer || winner===dealer
      const loseB = (gunner===dealer||winner===dealer)? -1 : 0;
      // －baseU + B×bonus
      delta[gunner] = -baseU + loseB * bonus;
    } else {
      P.filter(p=>p!==winner).forEach(p=>{
        const loseB = (p===dealer||winner===dealer)? -1 : 0;
        delta[p] = -baseU + loseB * bonus;
      });
    }

    // 勝方得分 = -Σ敗方
    delta[winner] = -P.reduce((s,p)=>s+delta[p],0);

    // 寫回
    P.forEach(p=>score[p]+=delta[p]);

    // 連莊
    if(winner===dealer) consec++;
    else{ dealer=nextSeat(dealer); consec=0; }

    updateBoard();
    updateDealerUI();
    modal.style.display="none";
  };

  // 初始化
  updateBoard();
  updateDealerUI();
</script>
</body>
</html>