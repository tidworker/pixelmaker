<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>麻將計分系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .player-buttons button, .options button, .loser-selection button, .input-section button, .back-button, .reset-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 80%;
        }
        table, th, td {
            border: 1px solid #000;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        .dealer {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>麻將計分系統</h1>

    <!-- 玩家按鈕 -->
    <div class="player-buttons">
        <button data-player="1">玩家1 (莊家)</button>
        <button data-player="2">玩家2</button>
        <button data-player="3">玩家3</button>
        <button data-player="4">玩家4</button>
    </div>

    <!-- 選項：吃胡 或 自摸 -->
    <div class="options hidden">
        <h2>請選擇</h2>
        <button id="chihu">吃胡</button>
        <button id="zimo">自摸</button>
    </div>

    <!-- 選擇輸家 -->
    <div class="loser-selection hidden">
        <h2>請選擇放槍玩家</h2>
        <div id="loser-buttons"></div>
    </div>

    <!-- 輸入台數 -->
    <div class="input-section hidden">
        <h2>請輸入台數</h2>
        <input type="number" id="taishu" min="0" value="0" placeholder="台數">
        <button id="confirm-score">確定計分</button>
    </div>

    <!-- 結果表格 -->
    <div class="result-section hidden">
        <h2>累計分數</h2>
        <table>
            <thead>
                <tr>
                    <th>玩家</th>
                    <th>累計分數</th>
                </tr>
            </thead>
            <tbody id="score-table-body">
                <!-- 分數將在此顯示 -->
            </tbody>
        </table>
    </div>

    <!-- 回合紀錄表格 -->
    <div class="record-section hidden">
        <h2>回合成績紀錄</h2>
        <table>
            <thead>
                <tr>
                    <th>回合</th>
                    <th>玩家1</th>
                    <th>玩家2</th>
                    <th>玩家3</th>
                    <th>玩家4</th>
                </tr>
            </thead>
            <tbody id="record-table-body">
                <!-- 回合紀錄將在此顯示 -->
            </tbody>
        </table>
    </div>

    <!-- 重新開始按鈕 -->
    <div class="reset-section hidden">
        <button class="reset-button" onclick="resetSystem()">重新開始</button>
    </div>

    <script>
        // 全局變量
        let currentPlayer = 1; // 當前選擇的勝利玩家
        let dealer = 1; // 當前莊家，預設為玩家1
        let losers = [];
        const base = 50;
        const multiplier = 20;
        let scoresTotal = [0, 0, 0, 0, 0]; // 玩家1-4，索引0忽略
        let rounds = []; // 用於記錄每回合的分數
        let currentRound = 1; // 回合計數

        // 獲取元素
        const playerButtons = document.querySelectorAll('.player-buttons button');
        const optionsDiv = document.querySelector('.options');
        const chihuButton = document.getElementById('chihu');
        const zimoButton = document.getElementById('zimo');
        const loserSelectionDiv = document.querySelector('.loser-selection');
        const loserButtonsDiv = document.getElementById('loser-buttons');
        const inputSection = document.querySelector('.input-section');
        const confirmScoreButton = document.getElementById('confirm-score');
        const taishuInput = document.getElementById('taishu');
        const resultSection = document.querySelector('.result-section');
        const scoreTableBody = document.getElementById('score-table-body');
        const recordSection = document.querySelector('.record-section');
        const recordTableBody = document.getElementById('record-table-body');
        const resetSection = document.querySelector('.reset-section');

        // 函數：獲取下一位莊家
        function getNextDealer(currentDealer) {
            return currentDealer % 4 + 1; // 1→2, 2→3, 3→4, 4→1
        }

        // 函數：更新主頁面莊家標示
        function updateDealerLabel() {
            playerButtons.forEach(button => {
                const player = parseInt(button.getAttribute('data-player'));
                if (player === dealer) {
                    button.textContent = `玩家${player} (莊家)`;
                    button.classList.add('dealer');
                } else {
                    // 移除之前的莊家標示
                    button.textContent = `玩家${player}`;
                    button.classList.remove('dealer');
                }
            });
        }

        // 初始更新莊家標示
        updateDealerLabel();

        // 點擊玩家按鈕
        playerButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentPlayer = parseInt(button.getAttribute('data-player'));
                optionsDiv.classList.remove('hidden');
                // 隱藏其他部分
                loserSelectionDiv.classList.add('hidden');
                inputSection.classList.add('hidden');
                resultSection.classList.add('hidden');
                recordSection.classList.add('hidden');
                resetSection.classList.add('hidden');
            });
        });

        // 點擊吃胡
        chihuButton.addEventListener('click', () => {
            optionsDiv.classList.add('hidden');
            loserSelectionDiv.classList.remove('hidden');
            // 顯示其他三個玩家作為輸家選項
            loserButtonsDiv.innerHTML = '';
            playerButtons.forEach(button => {
                const player = parseInt(button.getAttribute('data-player'));
                if (player !== currentPlayer) {
                    const btn = document.createElement('button');
                    btn.textContent = `玩家${player}`;
                    btn.addEventListener('click', () => {
                        losers = [player];
                        loserSelectionDiv.classList.add('hidden');
                        inputSection.classList.remove('hidden');
                        // 重置輸入欄位
                        taishuInput.value = 0;
                    });
                    loserButtonsDiv.appendChild(btn);
                }
            });
        });

        // 點擊自摸
        zimoButton.addEventListener('click', () => {
            optionsDiv.classList.add('hidden');
            losers = [1,2,3,4].filter(p => p !== currentPlayer);
            inputSection.classList.remove('hidden');
            // 隱藏輸家選擇
            loserSelectionDiv.classList.add('hidden');
            // 重置輸入欄位
            taishuInput.value = 0;
        });

        // 計分
        confirmScoreButton.addEventListener('click', () => {
            const taishu = parseInt(taishuInput.value);
            if (isNaN(taishu) || taishu < 0) { // 允許台數為0
                alert('請輸入有效的台數（0或更高）');
                return;
            }

            let score;
            if (taishu === 0) {
                score = base;
            } else {
                score = taishu * multiplier + base;
            }

            // 計算分數
            const roundScores = [0, 0, 0, 0, 0]; // 玩家1-4，索引0忽略
            losers.forEach(loser => {
                scoresTotal[loser] -= score;
                roundScores[loser] -= score;
                scoresTotal[currentPlayer] += score;
                roundScores[currentPlayer] += score;
            });

            // 記錄回合分數
            rounds.push({
                round: currentRound,
                player1: roundScores[1],
                player2: roundScores[2],
                player3: roundScores[3],
                player4: roundScores[4]
            });
            currentRound++;

            // 決定是否換莊
            if (currentPlayer !== dealer) {
                dealer = getNextDealer(dealer);
                updateDealerLabel(); // 更新主頁面莊家標示
            }
            // 如果 winner 是莊家，莊家保持不變

            // 生成結果表格
            scoreTableBody.innerHTML = '';
            for (let i = 1; i <=4; i++) {
                const row = document.createElement('tr');
                const playerCell = document.createElement('td');
                playerCell.textContent = `玩家${i}`;
                if (i === dealer) {
                    playerCell.textContent += ' (莊家)';
                    playerCell.classList.add('dealer');
                }
                const scoreCell = document.createElement('td');
                scoreCell.textContent = scoresTotal[i];
                row.appendChild(playerCell);
                row.appendChild(scoreCell);
                scoreTableBody.appendChild(row);
            }

            // 生成回合紀錄表格
            recordTableBody.innerHTML = '';
            rounds.forEach(r => {
                const row = document.createElement('tr');
                const roundCell = document.createElement('td');
                roundCell.textContent = r.round;
                const p1Cell = document.createElement('td');
                p1Cell.textContent = r.player1;
                const p2Cell = document.createElement('td');
                p2Cell.textContent = r.player2;
                const p3Cell = document.createElement('td');
                p3Cell.textContent = r.player3;
                const p4Cell = document.createElement('td');
                p4Cell.textContent = r.player4;
                row.appendChild(roundCell);
                row.appendChild(p1Cell);
                row.appendChild(p2Cell);
                row.appendChild(p3Cell);
                row.appendChild(p4Cell);
                recordTableBody.appendChild(row);
            });

            // 顯示結果和回合紀錄
            resultSection.classList.remove('hidden');
            recordSection.classList.remove('hidden');
            resetSection.classList.remove('hidden');
        });

        // 重置系統
        function resetSystem() {
            currentPlayer = 1;
            dealer = 1;
            losers = [];
            optionsDiv.classList.add('hidden');
            loserSelectionDiv.classList.add('hidden');
            inputSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            recordSection.classList.add('hidden');
            resetSection.classList.add('hidden');
            taishuInput.value = 0;
            // 重置分數
            scoresTotal = [0, 0, 0, 0, 0];
            scoreTableBody.innerHTML = '';
            // 重置回合紀錄
            rounds = [];
            recordTableBody.innerHTML = '';
            currentRound = 1;
            // 更新莊家標示
            updateDealerLabel();
        }

        // 初始化隱藏所有選項
        window.onload = function() {
            optionsDiv.classList.add('hidden');
            loserSelectionDiv.classList.add('hidden');
            inputSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            recordSection.classList.add('hidden');
            resetSection.classList.add('hidden');
        }
    </script>

</body>
</html>